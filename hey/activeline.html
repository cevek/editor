<!doctype html>

<title>CodeMirror: Active Line Demo</title>
<meta charset="utf-8"/>
<link rel=stylesheet href="../doc/docs.css">

<link rel="stylesheet" href="../lib/codemirror.css">
<script src="../lib/codemirror.js"></script>
<script src="../addon/selection/active-line.js"></script>
<style type="text/css">
    .CodeMirror {
        border-top: 1px solid black;
        border-bottom: 1px solid black;
        font-family: "Consolas", monaco, monospace
    }
    .CodeMirror {
        display: inline-block;
        width: 500px;
        vertical-align: top;
    }
    #timing { line-height: 1; padding: 4px 0;font-family: consolas, menlo, monaco, monospace; display: inline-block; width: 50px; vertical-align: top; }
</style>
<h2>Active Line Demo</h2>
<div id="timing"></div>

<svg width="190px" height="160px" version="1.1" xmlns="http://www.w3.org/2000/svg">
    <path d="M0,50 C15,50 15,80 30,80 L30,120 C15,120 15,70 0,70Z" stroke="black" f1ill="transparent"/>
</svg>

<textarea id="code" name="code">
10
20
30
40
50
60
70
80
90
10
</textarea>
<textarea id="code2" name="code">
10
20
30
40
50
60
70
80
90
10
</textarea>

<script>
    var timing = document.getElementById('timing');
    var editor = CodeMirror.fromTextArea(document.getElementById("code"), {
        styleActiveLine: true,
        lineNumbers: true,
        lineWrapping: true
    });
    var editor2 = CodeMirror.fromTextArea(document.getElementById("code2"), {
        styleActiveLine: true,
        lineNumbers: true,
        lineWrapping: true
    });

    var lineCount = editor.doc.lineCount();
    for (var i = 0; i < lineCount; i++) {
        var div = document.createElement('div');
        div.textContent = i;//Math.random().toString(33).substr(3, 4);
        timing.appendChild(div);
    }

    editor.on('beforeChange', function (cm, changes) {
        if (changes.origin == 'undo'){
            editor2.doc.undo();
            return;
        }
        if (changes.origin == 'redo'){
            editor2.doc.redo();
            return;
        }

        var from = changes.from;
        var to = changes.to;
        if (CodeMirror.cmpPos(to, from) < 0) {
            console.log("Change from to");
            var tmp = to;
            to = from;
            from = tmp;
        }

        var line = from.line;
        if (from.ch === 0) {
            line--;
        }
        var insert = "";
        for (var i = 0; i < changes.text.length - 1; i++) {
            insert += "\n";
            var div = document.createElement('div');
            div.textContent = Math.random().toString(33).substr(3, 4);
            timing.insertBefore(div, timing.children[line+1]);
        }
        if (insert) {
            editor2.doc.replaceRange(insert, CodeMirror.Pos(line), CodeMirror.Pos(line));
        }

        var emptyLines = 0;
        var insertLen = changes.text.length - 1;
        var deleteCount = to.line - from.line;
        var i = from.line;
        if (from.ch > 0) {
            i++;
        }
        var j = i;
        for (; i <= to.line; i++, j++) {
            if (deleteCount && j > 0) {
                var child = timing.children[j];
                if (child) {
                    timing.removeChild(child);
                }
                editor2.doc.replaceRange("", CodeMirror.Pos(j - 1, editor2.doc.getLine(j - 1).length), CodeMirror.Pos(j));
                deleteCount--;
                j--;
            }
        }
    });



    function pathGenerator(topLeft, leftHeight, topRight, rightHeight, width) {
        var bx = width / 2 | 0;
        var path = '';
        path += 'M0,' + topLeft + ' ';

        path += 'C' + bx + ',' + topLeft + ' ';
        path += bx + ',' + topRight + ' ';
        path += width + ',' + topRight + ' ';

        path += 'L' + width + ',' + (topRight + rightHeight) + ' ';

        path += 'C' + bx + ',' + (topRight + rightHeight) + ' ';
        path += bx + ',' + (topLeft + leftHeight) + ' ';
        path += '0,' + (topLeft + leftHeight) + 'Z';
        return path;
    }


    /*	// end of line
        var from = changes.from;
        var to = changes.to;
        if (CodeMirror.cmpPos(to, from) < 0) {
            console.log("Change from to");
            var tmp = to;
            to = from;
            from = tmp;
        }

        from = CodeMirror.Pos(from.line, editor.doc.getLine(from.line).length);
        if (CodeMirror.cmpPos(to, from) < 0) {
            console.log("Change from to");
            var tmp = to;
            to = from;
            from = tmp;
        }

        var string = editor2.doc.getRange(from, to);
        if (string.trim() === '') {
            console.log("remove", from, to);
            editor2.doc.replaceRange("", from, to);
        }

        if (insert) {
            editor2.doc.replaceRange(insert, CodeMirror.Pos(line), CodeMirror.Pos(line));
        }

        console.log(editor.doc.children[0].lines);*/
</script>

